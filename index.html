<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Deadlands Powers App</title>

  <!-- Tailwind -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

  <style>
    .modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center;
             background: rgba(0,0,0,0.6); z-index: 50; padding: 0; }
    .modal.open { display: flex; }
    .modal-content { background: #fff; border-radius: .5rem; width: 100%; height: auto;
                     max-height: 90vh; overflow-y: auto; padding: 1.25rem; position: relative; }
    @media (min-width: 768px) {
      .modal-content { max-width: 900px; max-height: 80vh; margin: 2rem; }
    }
    .close-btn { position: absolute; top: .75rem; right: .75rem; font-weight: 700;
                 background: transparent; border: none; cursor: pointer; font-size: 1.5rem; }
    .modal-text { white-space: pre-wrap; }
    .focus-ring:focus { outline: 3px solid rgba(99,102,241,0.35); outline-offset: 2px; }
    .tab-active { border-bottom: 2px solid #4F46E5; font-weight: 600; }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">

  <div class="container mx-auto p-4 text-center">
    <!-- Logo -->
    <img src="https://raw.githubusercontent.com/TKrom16/Deadlands-Powers/refs/heads/main/New_Deadlands_Logo.png" 
         alt="Deadlands Logo" 
         class="mx-auto w-full max-w-md mb-4">

    <!-- Title -->
    <h1 class="text-2xl md:text-3xl font-bold mb-6">Powers App</h1>
  </div>

  <!-- Tabs + Rank Filter + Common Modifiers -->
  <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3 mb-4">
    <div class="flex gap-4 border-b pb-2">
      <button id="tabAll" class="pb-2 focus-ring tab-active">All Powers</button>
      <button id="tabFavs" class="pb-2 focus-ring">My Powers ‚≠ê</button>
    </div>
    <div class="flex items-center gap-2">
      <select id="rankFilter" class="border p-2 rounded">
        <option value="">All Ranks</option>
        <option>Novice</option>
        <option>Seasoned</option>
        <option>Veteran</option>
        <option>Heroic</option>
      </select>
      <button id="btnCommonMods" class="border p-2 rounded bg-white focus-ring">üîß Common Modifiers</button>
    </div>
  </div>

  <!-- Search + Clear -->
  <div class="flex items-center gap-2 mb-4">
    <input id="searchBox" 
           type="search" 
           placeholder="Search name or summary..." 
           class="border p-2 rounded flex-grow min-w-0" />
    <button id="clearBtn" 
            class="border p-2 rounded bg-gray-50 flex-shrink-0">
      Clear
    </button>
  </div>

  <div id="powersList" class="grid gap-3 grid-cols-1 md:grid-cols-2"></div>

  <!-- Power Modal -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="modal-content" id="modalContent" onclick="event.stopPropagation()">
      <button id="modalClose" class="close-btn">‚úï</button>

      <!-- Title + Rank -->
      <h2 id="modalName" class="text-2xl font-bold mb-1"></h2>
      <p id="modalRank" class="text-sm text-red-700 font-semibold mb-3"></p>

      <!-- Stats row -->
      <div class="text-sm text-gray-700 mb-3 space-y-1">
        <div>üîã <strong>Power Points:</strong> <span id="modalPP"></span></div>
        <div>üìè <strong>Range:</strong> <span id="modalRange"></span></div>
        <div>üïë <strong>Duration:</strong> <span id="modalDuration"></span></div>
      </div>

      <!-- Divider before description -->
      <hr class="my-3 border-gray-300" />

      <!-- Full description -->
      <div class="mb-6">
        <h3 class="font-semibold mb-2">Description</h3>
        <div id="modalText" class="modal-text text-gray-900 text-base leading-relaxed"></div>
      </div>

      <!-- Divider before modifiers -->
      <hr class="my-3 border-gray-300" />

      <!-- Modifiers -->
      <div id="modalModifiersContainer" class="mt-4 hidden">
        <h3 class="font-semibold mb-2">Power Modifiers</h3>
        <div id="modalModifiers" class="space-y-3"></div>
      </div>

      <!-- Divider after modifiers -->
      <hr class="my-3 border-gray-300" />

      <!-- Source -->
      <p id="modalSource" class="text-sm text-gray-600 mb-3"></p>

      <!-- Buttons -->
      <div class="mt-6 flex gap-2">
        <button id="modalFavBtn" class="px-3 py-2 rounded bg-indigo-600 text-white">‚≠ê Add to My Powers</button>
        <button id="modalCopyBtn" class="px-3 py-2 rounded border bg-white">Copy Summary</button>
      </div>
    </div>
  </div>

  <!-- Common Modifiers Modal -->
  <div id="commonModal" class="modal" aria-hidden="true">
    <div class="modal-content" id="commonModalContent" onclick="event.stopPropagation()">
      <button id="commonModalClose" class="close-btn">‚úï</button>
      <h2 class="text-xl font-bold mb-2">Common Modifiers</h2>
      <div id="commonModifiersList" class="space-y-2"></div>
    </div>
  </div>

  <script>
    let allPowers = [];
    let favorites = new Set();
    let currentTab = "all";
    let commonModifiers = [];

    const listEl = document.getElementById('powersList');
    const rankFilter = document.getElementById('rankFilter');
    const searchBox = document.getElementById('searchBox');
    const clearBtn = document.getElementById('clearBtn');
    const tabAll = document.getElementById('tabAll');
    const tabFavs = document.getElementById('tabFavs');
    const btnCommonMods = document.getElementById('btnCommonMods');

    const modal = document.getElementById('modal');
    const modalName = document.getElementById('modalName');
    const modalRank = document.getElementById('modalRank');
    const modalPP = document.getElementById('modalPP');
    const modalRange = document.getElementById('modalRange');
    const modalDuration = document.getElementById('modalDuration');
    const modalText = document.getElementById('modalText');
    const modalModifiersContainer = document.getElementById('modalModifiersContainer');
    const modalModifiers = document.getElementById('modalModifiers');
    const modalClose = document.getElementById('modalClose');
    const modalFavBtn = document.getElementById('modalFavBtn');
    const modalCopyBtn = document.getElementById('modalCopyBtn');

    const commonModal = document.getElementById('commonModal');
    const commonModifiersList = document.getElementById('commonModifiersList');
    const commonModalClose = document.getElementById('commonModalClose');

    async function loadPowers() {
      const res = await fetch('powers.json');
      const json = await res.json();
      commonModifiers = json.common_modifiers || [];
      allPowers = json.powers || [];
      loadFavorites();
      renderCommonModifiers();
      renderPowers();
    }

    function loadFavorites() {
      const stored = localStorage.getItem('favorites');
      if (stored) favorites = new Set(JSON.parse(stored));
    }

    function saveFavorites() {
      localStorage.setItem('favorites', JSON.stringify([...favorites]));
    }

    function toggleFavorite(id) {
      favorites.has(id) ? favorites.delete(id) : favorites.add(id);
      saveFavorites();
      renderPowers();
    }

    function renderPowers() {
      const rank = rankFilter.value;
      const q = searchBox.value.toLowerCase().trim();

      let filtered = allPowers.filter(p => {
        return (!rank || p.rank === rank) &&
               (!q || (p.name + " " + p.summary).toLowerCase().includes(q));
      });

      if (currentTab === "favs") {
        filtered = filtered.filter(p => favorites.has(p.id));
      }

      listEl.innerHTML = filtered.length ? "" : '<div class="p-4 text-gray-600">No powers found.</div>';

      filtered.forEach(p => {
        const card = document.createElement('div');
        card.className = 'border rounded p-3 bg-white cursor-pointer hover:shadow';

        const header = document.createElement('div');
        header.className = 'flex justify-between items-center';
        header.innerHTML = `<span class="font-semibold">${p.name}</span>
                            <div class="flex items-center gap-2">
                              <span class="text-sm text-gray-600">${p.rank}</span>
                              <button class="text-xl">${favorites.has(p.id) ? "‚≠ê" : "‚òÜ"}</button>
                            </div>`;

        const favBtn = header.querySelector("button");
        favBtn.onclick = e => { e.stopPropagation(); toggleFavorite(p.id); };

        const stats = `<div class="text-xs text-gray-700 mt-1 flex gap-2">
          <span>üîã ${p.power_points}</span>
          <span>üìè ${p.range}</span>
          <span>üïë ${p.duration}</span>
        </div>`;

        const summary = `<p class="text-sm mt-2">${p.summary}</p>`;

        card.innerHTML = "";
        card.appendChild(header);
        card.insertAdjacentHTML("beforeend", stats + summary);
        card.onclick = () => openModal(p);

        listEl.appendChild(card);
      });
    }

    function openModal(p) {
      modalName.textContent = p.name;
      modalRank.textContent = `Rank: ${p.rank}`;
      modalPP.textContent = p.power_points;
      modalRange.textContent = p.range;
      modalDuration.textContent = p.duration;
      modalText.innerHTML = p.full_text;

      // Modifiers
      modalModifiers.innerHTML = "";
      if (p.modifiers?.length) {
        modalModifiersContainer.classList.remove("hidden");
        p.modifiers.forEach(m => {
          modalModifiers.insertAdjacentHTML("beforeend",
            `<div class="border rounded bg-gray-50 p-3">
               <p class="font-semibold text-red-700">
                 ${m.name} <span class="text-gray-800">(${m.cost})</span>
               </p>
               <p class="text-sm text-gray-700 mt-1">${m.description}</p>
             </div>`);
        });
      } else {
        modalModifiersContainer.classList.add("hidden");
      }

      // Source (always show if present)
      if (p.source) {
        document.getElementById("modalSource").textContent = `Source: ${p.source}`;
      } else {
        document.getElementById("modalSource").textContent = "";
      }

      modalFavBtn.textContent = favorites.has(p.id) ? "‚≠ê Remove from My Powers" : "‚òÜ Add to My Powers";
      modalFavBtn.onclick = () => { toggleFavorite(p.id); closeModal(); };

      modalCopyBtn.onclick = () => {
        navigator.clipboard.writeText(`${p.name} (${p.rank})\nPP: ${p.power_points}, Range: ${p.range}, Duration: ${p.duration}\n\n${p.full_text}`);
        modalCopyBtn.textContent = "Copied!";
        setTimeout(() => modalCopyBtn.textContent = "Copy Summary", 1200);
      };

      modal.classList.add("open");
    }

    function closeModal() { modal.classList.remove("open"); }
    modalClose.onclick = closeModal;
    modal.onclick = e => { if (e.target === modal) closeModal(); };
    document.addEventListener('keydown', e => { if (e.key === "Escape") { closeModal(); closeCommonModal(); }});

    function renderCommonModifiers() {
      commonModifiersList.innerHTML = "";
      commonModifiers.forEach(m => {
        commonModifiersList.insertAdjacentHTML("beforeend",
          `<div class="border rounded p-3 bg-gray-50">
             <p class="font-semibold text-red-700">
               ‚ñ™ ${m.name} <span class="text-gray-800">(${m.cost})</span>
             </p>
             <p class="text-sm text-gray-800 ml-4">${m.description}</p>
           </div>`);
      });
    }

    function openCommonModal() { commonModal.classList.add("open"); }
    function closeCommonModal() { commonModal.classList.remove("open"); }
    btnCommonMods.onclick = openCommonModal;
    commonModalClose.onclick = closeCommonModal;
    commonModal.onclick = e => { if (e.target === commonModal) closeCommonModal(); };

    rankFilter.onchange = renderPowers;
    searchBox.oninput = renderPowers;
    clearBtn.onclick = () => { rankFilter.value=""; searchBox.value=""; renderPowers(); };
    tabAll.onclick = () => { currentTab="all"; tabAll.classList.add("tab-active"); tabFavs.classList.remove("tab-active"); renderPowers(); };
    tabFavs.onclick = () => { currentTab="favs"; tabFavs.classList.add("tab-active"); tabAll.classList.remove("tab-active"); renderPowers(); };

    document.addEventListener("DOMContentLoaded", loadPowers);
  </script>
</body>
</html>
